{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "title": "Connect Configuration Schema",
  "type": "object",
  "properties": {
    "connect": {
      "type": "object",
      "description": "Configuration settings for the Connect service.",
      "properties": {
        "urlBase": {
          "type": "string",
          "description": "The base URL for the Connect service."
        },
        "allowedOrigins": {
          "type": "array",
          "description": "List of allowed origins for cross-origin requests.",
          "items": {
            "type": "string"
          }
        },
        "insecureServerAddress": {
          "type": "object",
          "description": "Address for the insecure Connect server endpoint.",
          "properties": {
            "host": {
              "type": "string"
            },
            "port": {
              "type": "integer"
            }
          },
          "required": ["host", "port"]
        },
        "adsServerAddress": {
          "type": "object",
          "description": "Address for the ADS server endpoint.",
          "properties": {
            "host": {
              "type": "string"
            },
            "port": {
              "type": "integer"
            }
          },
          "required": ["host", "port"]
        },
        "spiffeEndpointSocket": {
          "type": "string",
          "description": "SPIFFE endpoint socket path/URL."
        },
        "trustBundleStoreBackend": {
          "type": "object",
          "description": "Configuration of the trust bundle store backend to use. Only one backend may be enabled.",
          "anyOf": [
            {
              "properties": {
                "s3": {
                  "type": "object",
                  "description": "Configuration for S3 trust bundle store backend.",
                  "properties": {
                    "enabled": {
                      "type": "boolean",
                      "description": "True to enable the S3 backend."
                    },
                    "bucket": {
                      "type": "string",
                      "description": "Name of bucket to use as trust bundle store."
                    },
                    "oidc": {
                      "type": "object",
                      "description": "Configuration to use OIDC to access S3, exchanging the Connect server's SVID for AWS credentials.",
                      "properties": {
                        "enabled": {
                          "type": "boolean",
                          "description": "True to use OIDC with the server's SVID to get temporary credentials to access S3 using OIDC, otherwise the AWS credentials will be sourced from the environment."
                        },
                        "awsRegion": {
                          "type": "string",
                          "description": "Region to set in the AWS config when obtaining credentials through OIDC."
                        },
                        "iamRoleARN": {
                          "type": "string",
                          "description": "ARN of AWS role to assume when obtaining credentials through OIDC."
                        },
                        "audience": {
                          "type": "string",
                          "description": "Audience expected by the OIDC provider in AWS."
                        }
                      },
                      "required": [
                        "enabled",
                        "awsRegion",
                        "iamRoleARN",
                        "audience"
                      ]
                    }
                  },
                  "required": ["enabled", "bucket", "oidc"]
                }
              }
            },
            {
              "properties": {
                "gcs": {
                  "type": "object",
                  "description": "Configuration for GCS trust bundle store backend.",
                  "properties": {
                    "enabled": {
                      "type": "boolean",
                      "description": "True to enable the GCS backend."
                    },
                    "bucket": {
                      "type": "string",
                      "description": "Name of bucket to use as trust bundle store."
                    },
                    "oidc": {
                      "type": "object",
                      "description": "Configuration to use OIDC to access GCS, exchanging the Connect server's SVID for GCP credentials.",
                      "properties": {
                        "enabled": {
                          "type": "boolean",
                          "description": "True to use OIDC with the server's SVID to get temporary credentials to access GCS using OIDC, otherwise the GCP credentials will be sourced from the environment."
                        },
                        "workloadIdentityProvider": {
                          "type": "string",
                          "description": "Fully qualified identifier of GCP workload identity provider to use when obtaining credentials through OIDC. Must be in the form projects/PROJECT_ID/locations/global/workloadIdentityPools/WORKLOAD_IDENTITY_POOL_NAME/providers/WORKLOAD_IDENTITY_PROVIDER_NAME."
                        },
                        "audience": {
                          "type": "string",
                          "description": "Audience expected by the OIDC provider in GCP."
                        }
                      },
                      "required": [
                        "enabled",
                        "workloadIdentityProvider",
                        "audience"
                      ]
                    }
                  },
                  "required": ["enabled", "bucket", "oidc"]
                }
              }
            }
          ]
        },
	"datastore": {
	  "type": "object",
	  "description": "Configuration of the datastore used by Connect",
	  "properties": {
	    "cloudSQL": {
	      "type": "object",
	      "description": "Google CloudSQL configuration",
	      "properties": {
                "enabled": {
                  "type": "boolean",
                  "description": "True to enable Google CloudSQL as the datastore"
                },
                "instance": {
                  "type": "string",
                  "description": "CloudSQL database instance. Format: project_name:region:instance_name"
                },
                "databaseName": {
                  "type": "string",
                  "description": "Name of the Connect database",
                  "minLength": 1
                },
	        "oidc": {
                  "type": "object",
                  "description": "Configuration to use OIDC to access Google CloudSQL",
                  "properties": {
                    "workloadIdentityProvider": {
                      "type": "string",
                      "description": "Fully qualified identifier of GCP workload identity provider."
                    },
                    "audience": {
                      "type": "string",
                      "description": "Audience expected by the OIDC provider in GCP"
                    },
                    "serviceAccountName": {
                      "type": "string",
                      "description": "Name of service account with access privileges to the Connect database"
                    }
                  }
	        }
	      }
	    }
          }
	},
        "connectPSATAudience": {
          "type": "string",
          "description": "Audience value to expect when using PSATs for Cofide SPIRE."
        },
        "trustDomain": {
          "type": "string",
          "description": "The trust domain of the Connect trust zone."
        },
        "connectTrustBundleStoreURL": {
          "type": "string",
          "description": "URL for the Connect trust bundle store."
        },
        "sqlConnectionString": {
          "type": "string",
          "description": "Connection string for the SQL database."
        },
        "sqlRemoteSPIFFEID": {
          "type": "string",
          "description": "SPIFFE ID for the remote SQL server."
        },
        "telemetryEnabled": {
          "type": "boolean",
          "description": "Flag to enable/disable telemetry."
        },
        "authzPolicyEngine": {
          "type": "string",
          "description": "The authorization policy engine to use."
        },
        "initialRBAC": {
          "type": "object",
          "description": "Initial RBAC configuration to bootstrap the system.",
          "properties": {
            "version": {
              "type": "integer",
              "description": "Version of the initial RBAC configuration (bump this to trigger RBAC bootstrap on next restart, version 0 means it will be ignored)."
            },
            "roleBindings": {
              "type": "array",
              "description": "List of initial role bindings.",
              "items": {
                "type": "object",
                "description": "A single role binding definition.",
                "allOf": [
                  {
                    "properties": {
                      "roleID": {
                        "type": "string",
                        "description": "ID of the role to bind"
                      },
                      "resourceType": {
                        "type": "string",
                        "description": "Type of resource to bind to"
                      },
                      "resourceID": {
                        "type": "string",
                        "description": "ID of resource to bind to"
                      }
                    },
                    "required": ["roleID", "resourceType", "resourceID"]
                  },
                  {
                    "oneOf": [
                      {
                        "properties": {
                          "user": {
                            "type": "object",
                            "description": "User to bind to",
                            "properties": {
                              "subject": {
                                "type": "string",
                                "description": "JWT subject value to match for binding"
                              }
                            },
                            "required": ["subject"]
                          }
                        },
                        "required": ["user"]
                      },
                      {
                        "properties": {
                          "group": {
                            "type": "object",
                            "description": "Group to bind to",
                            "properties": {
                              "claimValue": {
                                "type": "string",
                                "description": "Value in JWT groups claim to match for binding"
                              }
                            },
                            "required": ["claimValue"]
                          }
                        },
                        "required": ["group"]
                      }
                    ]
                  }
                ]
              }
            }
          },
          "required": ["version", "roleBindings"]
        },
        "extraEnv": {
          "type": "array",
          "description": "Additional environment variables to pass to the connect api binary.",
          "items": {
            "type": "object",
            "allOf": [
              {
                "properties": {
                  "name": {
                    "type": "string",
                    "description": "Environment variable name"
                  }
                },
                "required": ["name"]
              }
            ],
            "oneOf": [
              {
                "properties": {
                  "value": {
                    "type": "string",
                    "description": "Simple string value to be set as environment variable"
                  }
                },
                "required": ["value"]
              },
              {
                "properties": {
                  "valueFrom": {
                    "type": "object",
                    "description": "Source of environment value as defined in https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.34/#envvarsource-v1-core"
                  }
                },
                "required": ["valueFrom"]
              }
            ]
          }
        }
      },
      "required": [
        "urlBase",
        "allowedOrigins",
        "insecureServerAddress",
        "adsServerAddress",
        "spiffeEndpointSocket",
        "trustBundleStoreBackend",
        "connectPSATAudience",
        "trustDomain",
        "connectTrustBundleStoreURL",
        "sqlConnectionString",
        "sqlRemoteSPIFFEID",
        "telemetryEnabled",
        "authzPolicyEngine",
        "initialRBAC",
        "extraEnv"
      ]
    }
  },
  "required": ["connect"]
}
